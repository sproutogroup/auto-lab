<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phase 3.1 - VAPID Sync Test</title>
  <style>
   body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background: #f5f5f5;
   }
   .container {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
   }
   h1 {
    color: #dc2626;
   }
   h2 {
    color: #374151;
    margin-top: 30px;
   }
   .step {
    background: #f8f9fa;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
    border-left: 4px solid #dc2626;
   }
   button {
    background: #dc2626;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    margin: 10px 0;
   }
   button:hover {
    background: #b91c1c;
   }
   .success {
    color: #10b981;
   }
   .error {
    color: #ef4444;
   }
   .output {
    background: #111827;
    color: #f9fafb;
    padding: 15px;
    border-radius: 6px;
    font-family: "Monaco", "Consolas", monospace;
    font-size: 14px;
    white-space: pre-wrap;
    margin: 10px 0;
    max-height: 300px;
    overflow-y: auto;
   }
   .key-info {
    background: #dbeafe;
    padding: 15px;
    border-radius: 6px;
    margin: 10px 0;
   }
  </style>
 </head>
 <body>
  <div class="container">
   <h1>üöÄ Phase 3.1 - VAPID Sync Test</h1>
   <p>This test will generate a real browser subscription and test the complete push notification flow.</p>

   <div class="step">
    <h2>Step 1: VAPID Configuration</h2>
    <div class="key-info">
     <strong>New VAPID Public Key:</strong><br />
     <code>BAo_FnrKbB2p6gzRN8xTF65HGV94Xu-TSYf2VfaaISf9_Gn5j91I5X8v_1pb48aRFwV_dZrvUdVSWKRMDDVKHu8</code>
    </div>
    <p>‚úÖ Server environment variables updated</p>
    <p>‚úÖ Client configuration updated</p>
   </div>

   <div class="step">
    <h2>Step 2: Generate Real Browser Subscription</h2>
    <button onclick="generateSubscription()">Generate Real Subscription</button>
    <div id="subscriptionOutput" class="output" style="display: none"></div>
   </div>

   <div class="step">
    <h2>Step 3: Test Push Notification</h2>
    <button onclick="testPushNotification()" id="testPushBtn" disabled>Test Push Notification</button>
    <div id="pushOutput" class="output" style="display: none"></div>
   </div>

   <div class="step">
    <h2>Step 4: Results</h2>
    <div id="results">
     <p>Complete steps 2 and 3 to see results...</p>
    </div>
   </div>
  </div>

  <script>
   let realSubscription = null;
   let subscriptionId = null;

   function log(message, isError = false) {
    console.log(message);
    const timestamp = new Date().toISOString();
    return `[${timestamp}] ${isError ? "ERROR: " : ""}${message}\n`;
   }

   function urlBase64ToUint8Array(base64String) {
    const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
    const base64 = (base64String + padding).replace(/\-/g, "+").replace(/_/g, "/");

    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);

    for (let i = 0; i < rawData.length; ++i) {
     outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
   }

   async function generateSubscription() {
    const output = document.getElementById("subscriptionOutput");
    output.style.display = "block";
    output.textContent = "";

    try {
     output.textContent += log("Starting real browser subscription generation...");

     // Check if service worker is available
     if (!("serviceWorker" in navigator)) {
      throw new Error("Service Worker not supported");
     }

     if (!("PushManager" in window)) {
      throw new Error("Push messaging not supported");
     }

     output.textContent += log("‚úÖ Service Worker and Push Manager available");

     // Wait for service worker registration
     const registration = await navigator.serviceWorker.ready;
     output.textContent += log("‚úÖ Service Worker registered");

     // VAPID public key (fresh Phase 3.1 key)
     const vapidPublicKey =
      "BAo_FnrKbB2p6gzRN8xTF65HGV94Xu-TSYf2VfaaISf9_Gn5j91I5X8v_1pb48aRFwV_dZrvUdVSWKRMDDVKHu8";

     // Convert to Uint8Array
     const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);
     output.textContent += log("‚úÖ VAPID key converted to Uint8Array");

     // Generate real subscription
     const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: applicationServerKey,
     });

     realSubscription = subscription;

     output.textContent += log("‚úÖ Real browser subscription generated!");
     output.textContent += log("Subscription details:");
     output.textContent += log(
      JSON.stringify(
       {
        endpoint: subscription.endpoint,
        keys: {
         p256dh: subscription.keys.p256dh,
         auth: subscription.keys.auth,
        },
       },
       null,
       2,
      ),
     );

     // Register with our API
     const response = await fetch("/api/subscriptions", {
      method: "POST",
      headers: {
       "Content-Type": "application/json",
      },
      body: JSON.stringify({
       user_id: 1,
       endpoint: subscription.endpoint,
       keys: {
        p256dh: subscription.keys.p256dh,
        auth: subscription.keys.auth,
       },
       device_type: navigator.userAgent.includes("iPhone") ? "iOS" : "Browser",
       user_agent: navigator.userAgent,
      }),
     });

     const result = await response.json();

     if (result.success) {
      subscriptionId = result.subscription_id;
      output.textContent += log(`‚úÖ Subscription registered with ID: ${subscriptionId}`);
      document.getElementById("testPushBtn").disabled = false;
     } else {
      throw new Error(`API registration failed: ${result.message}`);
     }
    } catch (error) {
     output.textContent += log(`Subscription generation failed: ${error.message}`, true);
     console.error("Subscription error:", error);
    }
   }

   async function testPushNotification() {
    if (!subscriptionId) {
     alert("Please generate a subscription first");
     return;
    }

    const output = document.getElementById("pushOutput");
    output.style.display = "block";
    output.textContent = "";

    try {
     output.textContent += log("Testing push notification...");

     const response = await fetch("/debug/send-test-push", {
      method: "POST",
      headers: {
       "Content-Type": "application/json",
      },
      body: JSON.stringify({
       subscriptionId: subscriptionId,
      }),
     });

     const result = await response.json();

     if (result.success) {
      output.textContent += log("‚úÖ Push notification sent successfully!");
      output.textContent += log("Result: " + JSON.stringify(result, null, 2));

      // Update results
      document.getElementById("results").innerHTML = `
                        <p class="success">‚úÖ Phase 3.1 VAPID Sync Test - SUCCESS!</p>
                        <p>üîë Fresh VAPID keys configured</p>
                        <p>üì± Real browser subscription generated</p>
                        <p>üöÄ Push notification sent without errors</p>
                        <p>üìä Subscription ID: ${subscriptionId}</p>
                    `;
     } else {
      throw new Error(`Push test failed: ${result.message}`);
     }
    } catch (error) {
     output.textContent += log(`Push test failed: ${error.message}`, true);
     console.error("Push test error:", error);

     // Update results with error
     document.getElementById("results").innerHTML = `
                    <p class="error">‚ùå Phase 3.1 VAPID Sync Test - FAILED</p>
                    <p>Error: ${error.message}</p>
                `;
    }
   }
  </script>
 </body>
</html>
